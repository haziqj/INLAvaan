---
output: gfm
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(INLAvaan)
library(lavaan)
library(tidyverse)
```

# `{INLAvaan}`

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/haziqj/INLAvaan/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/haziqj/INLAvaan/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

> Bayesian structural equation modelling with INLA.

Soon-ish features

1. Model fit indices (PPP, xIC, RMSEA, etc.)
2. Prior specification.
3. Fixed values and/or parameter constraints.
4. Specify different families for different observed variable. 
5. Standardised coefficients.

Long term plan

1. "non-iid" models, such as spatio-temporal models.
2. Multilevel-ish kind of models (2-3 levels).
3. Covariates.
4. Multiple groups (yes, should be easy--but I'm lazy)

## First impressions

A simple two-factor SEM with 6 observed correlated Gaussian variables.

```{r}
#| echo: false
#| message: false
true_model <- "
  eta1 =~ 1*y1 + 1.2*y2 + 1.5*y3
  eta2 =~ 1*y4 + 1.2*y5 + 1.5*y6
  eta2 ~ 0.3*eta1

  y1 ~~ 0.05*y4
  y2 ~~ 0.05*y5
  y3 ~~ 0.05*y6

  y1 ~~ 0.1*y1
  y2 ~~ 0.1*y2
  y3 ~~ 0.1*y3
  y4 ~~ 0.1*y4
  y5 ~~ 0.1*y5
  y6 ~~ 0.1*y6
"
dat <- lavaan::simulateData(true_model, sample.nobs = 1000)

mod <- "
  eta1 =~ y1 + y2 + y3
  eta2 =~ y4 + y5 + y6
  eta1 ~ eta2
  y1 ~~ y4
  y2 ~~ y5
  y3 ~~ y6
"
sempath <- lavaan::sem(mod, dat)
semPlot::semPaths(sempath, layout = "tree", what = "est", fade = FALSE)
```

```{r}
# {lavaan} textual model
mod <- "
  eta1 =~ y1 + y2 + y3
  eta2 =~ y4 + y5 + y6
  eta1 ~ eta2
  y1 ~~ y4
  y2 ~~ y5
  y3 ~~ y6
"

# Data set
head(dat)
```


To fit this model using `{INLAvaan}`, use the familiar `{lavaan}` syntax. 
The `i` in `isem` stands for `INLA` (following the convention of `bsem` for `{blavaan}`).

```{r}
#| include: false
library(INLAvaan)
fit <- isem(model = mod, data = dat)
```

```{r}
#| eval: false
library(INLAvaan)
fit <- isem(model = mod, data = dat)
summary(fit)
```

```{r}
#| echo: false
summary(fit)
```

Compare model fit to `{lavaan}`:

```{r}
#| echo: false
library(tidyverse)
coef_lav <- lavaan::coef(sempath)
coef_inla <- lavaan::coef(fit)

lavaan::partable(sempath) |>
  select(id, op, lavaan = est) |>
  left_join(select(lavaan::partable(fit), id, INLAvaan = est, pxnames), by = "id") |>
  mutate(type = gsub("\\[[^]]*\\]", "", pxnames)) |>
  drop_na() |>
  ggplot(aes(INLAvaan, lavaan)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_point(aes(col = type), size = 3) +
  theme_bw() 
```

