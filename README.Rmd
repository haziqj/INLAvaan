---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(INLAvaan)
library(lavaan)
library(blavaan)
library(tidyverse)
library(semPlot)
library(semptools)
```

## `{INLAvaan}`

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/haziqj/INLAvaan/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/haziqj/INLAvaan/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

> Bayesian structural equation modelling with INLA.

**Soon-ish features**

1. Model fit indices (PPP, xIC, RMSEA, etc.)
2. Prior specification.
3. Fixed values and/or parameter constraints.
4. Specify different families for different observed variable. 
5. Standardised coefficients.

**Long term plan**

1. "Non-iid" models, such as spatio-temporal models.
2. Multilevel-ish kind of models (2-3 levels).
3. Covariates.
4. Multigroup analysis (in principle this is simple, but I have bigger plans for this).

## First impressions

A simple two-factor SEM with six observed, correlated Gaussian variables.
Let $i=1,\dots,n$ index the subjects.
Conditional on the values of $k$th latent variable $\eta_{ki}$ for subject $i$, the six measurement model equations are

<br>
<p align="center">
  <img src="man/figures/measeqn.gif" width="40%" style="display: block; margin: auto;" />
</p>
<br>
<!-- $$ -->
<!-- \begin{gathered} -->
<!-- y_{1i} = \lambda_{11} \eta_{1i} \phantom{+ \lambda_{1} \eta_{2i}} + \epsilon_{1i}, \quad \epsilon_{1i} \sim N(0, \theta_{11}) \\ -->
<!-- y_{2i} = \lambda_{21} \eta_{1i} \phantom{+ \lambda_{1} \eta_{2i}} + \epsilon_{2i}, \quad \epsilon_{2i} \sim N(0, \theta_{22}) \\ -->
<!-- y_{3i} = \lambda_{31} \eta_{1i} \phantom{+ \lambda_{1} \eta_{2i}}  + \epsilon_{3i}, \quad \epsilon_{3i} \sim N(0, \theta_{33}) \\ -->
<!-- y_{4i} = \phantom{\lambda_{11} \eta_{2i} +}  \lambda_{42} \eta_{2i} + \epsilon_{4i}, \quad \epsilon_{4i} \sim N(0, \theta_{44}) \\ -->
<!-- y_{5i} = \phantom{\lambda_{11} \eta_{2i} +} \lambda_{52} \eta_{2i} + \epsilon_{5i}, \quad \epsilon_{5i} \sim N(0, \theta_{55}) \\ -->
<!-- y_{6i} = \phantom{\lambda_{11} \eta_{2i} +} \lambda_{62} \eta_{2i} + \epsilon_{6i}, \quad \epsilon_{6i} \sim N(0, \theta_{66}) \\ -->
<!-- \\ -->
<!-- \operatorname{Cov}(\epsilon_{1i},\epsilon_{4i}) = \theta_{14} \\ -->
<!-- \operatorname{Cov}(\epsilon_{2i},\epsilon_{5i}) = \theta_{25} \\ -->
<!-- \operatorname{Cov}(\epsilon_{3i},\epsilon_{6i}) = \theta_{36} \\ -->
<!-- \end{gathered} -->
<!-- $$ -->

For identifiability, we set $\lambda_{11} = \lambda_{42} = 1$.
The structural part of the model are given by these equations:

<br>
<p align="center">
  <img src="man/figures/struceqn.gif" width="30%" style="display: block; margin: auto;" />
</p>
<br>
<!-- $$ -->
<!-- \begin{gathered} -->
<!-- \eta_{1i} = \phantom{b\eta_{1i} +} \zeta_{1i}, \quad \zeta_{1i} \sim N(0, \psi_1) \\ -->
<!-- \eta_{2i} = b\eta_{1i} + \zeta_{2i}, \quad \zeta_{2i} \sim N(0, \psi_2) -->
<!-- \end{gathered} -->
<!-- $$ -->

Graphically, we can plot the following path diagram.

```{r twofacsemsetup}
#| include: false
true_model <- "
  eta1 =~ 1*y1 + 1.2*y2 + 1.5*y3
  eta2 =~ 1*y4 + 1.2*y5 + 1.5*y6
  eta2 ~ 0.3*eta1

  y1 ~~ 0.05*y4
  y2 ~~ 0.05*y5
  y3 ~~ 0.05*y6

  y1 ~~ 0.1*y1
  y2 ~~ 0.1*y2
  y3 ~~ 0.1*y3
  y4 ~~ 0.1*y4
  y5 ~~ 0.1*y5
  y6 ~~ 0.1*y6
"
dat <- lavaan::simulateData(true_model, sample.nobs = 1000)

mod <- "
  eta1 =~ y1 + y2 + y3
  eta2 =~ y4 + y5 + y6
  eta2 ~ eta1
  y1 ~~ y4
  y2 ~~ y5
  y3 ~~ y6
"
fit_lav <- sem(mod, dat)
fit_lav@ParTable$est <- true_vals <-
  c(rep(c(1, 1.2, 1.5), 2), 0.3, rep(0.05, 3), rep(0.1, 6), rep(1, 2))

p <- semPlot::semPaths(
  fit_lav, 
  whatLabels = "est",
  node.width = 1,
  edge.label.cex = 0.75,
  # style = "ram",
  mar = c(-5, -1, 5, -1)
)
```

```{r}
#| label: sempath
#| echo: false
#| message: false

indicator_order <- c(
  "y1", "y2", "y3",
  "y4", "y5", "y6"
)
indicator_factor <- c(
  "eta1", "eta1", "eta1",
  "eta2", "eta2", "eta2"
)
factor_layout <- matrix(c("eta1", "eta2"), byrow = TRUE, nrow = 1)
factor_point_to <- matrix(c("up", "up"), byrow = TRUE, nrow = 1)
p2 <- set_sem_layout(
  p,
  indicator_order = indicator_order,
  indicator_factor = indicator_factor,
  factor_layout = factor_layout,
  factor_point_to = factor_point_to
) |>
  set_curve(c(
    "y1~~y4" = 3,
    "y2~~y5" = 3,
    "y3~~y6" = 3
  )) |>
  change_node_label(list(
    list(node = "et1", to = expression(eta[1])),
    list(node = "et2", to = expression(eta[2]))
  ))
plot(p2)
```

```{r}
# {lavaan} textual model
mod <- "
  # Measurement model
  eta1 =~ y1 + y2 + y3
  eta2 =~ y4 + y5 + y6
  
  # Factor regression
  eta2 ~ eta1
  
  # Covariances
  y1 ~~ y4
  y2 ~~ y5
  y3 ~~ y6
"

# Data set
head(dat)
```


To fit this model using `{INLAvaan}`, use the familiar `{lavaan}` syntax. 
The `i` in `isem` stands for `INLA` (following the convention of `bsem` for `{blavaan}`).

```{r inlafit, cache = TRUE}
#| include: false
library(INLAvaan)
fit <- isem(model = mod, data = dat)
fit_lav <- sem(mod, dat)
fit_blav <- bsem(mod, dat, n.chains = 1)
fit_blavvb <- bsem(mod, dat, target = "vb")
```

```{r}
#| eval: false
library(INLAvaan)
fit <- isem(model = mod, data = dat)
summary(fit)
```

```{r}
#| echo: false
summary(fit)
```

Compare model fit to `{lavaan}` and `{blavaan}` (MCMC sampling using Stan 500 burnin and 1000 samples, as well as variational Bayes):

```{r}
#| label: fig-compare
#| echo: false
#| cache: true
coef_lav <- lavaan::coef(fit_lav)
coef_inla <- lavaan::coef(fit)

lavaan::partable(fit_lav) |>
  select(id, op, lavaan = est) |>
  mutate(truth = true_vals) |>
  left_join(select(lavaan::partable(fit), id, INLAvaan = est, pxnames), by = "id") |>
  left_join(select(lavaan::partable(fit_blav), id, blavaan = est), by = "id") |>
  left_join(select(lavaan::partable(fit_blavvb), id, blavaan_vb = est), by = "id") |>
  mutate(type = gsub("\\[[^]]*\\]", "", pxnames)) |>
  drop_na() |>
  pivot_longer(c(lavaan, blavaan, blavaan_vb, INLAvaan)) |>
  ggplot(aes(value, truth)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_point(aes(col = type, shape = name), size = 3) +
  scale_shape_manual(values = c(0, 5, 1, 2)) +
  theme_bw() +
  labs(
    x = "Estimate",
    y = "True parameter value",
    color = "Parameter",
    shape = "Estimator"
  )

cat("Timing\n")
list(fit, fit_lav, fit_blav, fit_blavvb) |>
  set_names(c("INLAvaan", "lavaan", "blavaan", "blavaan_vb")) |>
  purrr::map_dbl(\(x) x@timing$total) 
```

## Outro

```{r}
sessioninfo::session_info()
```
