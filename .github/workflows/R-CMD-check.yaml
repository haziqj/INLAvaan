# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: R-CMD-check

permissions: read-all

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: true
      matrix:
        config:
          - {os: macos-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: ubuntu-latest,   r: 'devel', http-user-agent: 'release'}
          - {os: ubuntu-latest,   r: 'release'}
          - {os: ubuntu-latest,   r: 'oldrel-1'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v5

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true
          extra-repositories: "https://inla.r-inla-download.org/R/testing"

      # Clear transient R package caches to avoid version mismatches
      # This prevents pak from restoring incompatible cached packages across R versions
      - name: Clear transient R package caches
        run: |
          rm -rf /home/runner/work/_temp/Library/_cache || true
          rm -rf /home/runner/work/_temp/Library/* || true
          rm -rf /tmp/Rtmp* || true
          echo "Cleared transient R caches"

      # Preinstall Rcpp from GitHub for R-devel to avoid source build failures
      # R-devel (4.6.0) removed R_ext/PrtUtil.h header, causing older Rcpp source builds to fail
      # Installing the latest development version ensures compatibility
      - name: Preinstall Rcpp for R-devel
        if: matrix.config.r == 'devel' || matrix.config.r == '4.6.0'
        run: |
          Rscript -e 'options(repos = "https://packagemanager.posit.co/cran/__linux__/noble/latest"); install.packages("remotes")'
          Rscript -e 'remotes::install_github("RcppCore/Rcpp")'

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - name: Session info
        run: |
          options(width = 100)
          sessioninfo::session_info("installed", include_base = TRUE, info = "all")
        shell: Rscript {0}

      # R-version-aware cache prevents reusing incompatible packages across R versions
      - name: Check R Package (Ubuntu)
        if: matrix.config.os == 'ubuntu-latest'
        uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          args: 'c("--no-tests", "--no-manual")'  # skip tests on Ubuntu
          error-on: '"error"'
          cache-version: ${{ matrix.config.r }}-612

      - name: Check R Package #(Non-Ubuntu)
        if: matrix.config.os != 'ubuntu-latest'
        uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          error-on: '"error"'

